# ä¼äº«äº‘è‡ªç„¶äººè®¤è¯åŠŸèƒ½ä½¿ç”¨æ–‡æ¡£

## åŠŸèƒ½æ¦‚è¿°

æ–°å¢äº†åŠç¨äººå®åè®¤è¯åŠŸèƒ½ï¼Œé€šè¿‡ç¨åŠ¡APPè´¦å·ï¼ˆæ‰‹æœºå·+å¯†ç ï¼‰ç™»å½•ï¼Œè‡ªåŠ¨è·å–åŠç¨äººåä¸‹çš„æ‰€æœ‰ä¼ä¸šåˆ—è¡¨ï¼Œç”¨æˆ·å¯é€‰æ‹©è¦ç»‘å®šçš„ä¼ä¸šã€‚

## å®ç°æµç¨‹

### 1. ç”¨æˆ·è®¤è¯æµç¨‹

```
ç”¨æˆ·è®¿é—® â†’ å¡«å†™åŠç¨äººä¿¡æ¯ â†’ RSAåŠ å¯†å¯†ç  â†’ è°ƒç”¨ä¼äº«äº‘API â†’ è·å–ä¼ä¸šåˆ—è¡¨ â†’ é€‰æ‹©ä¼ä¸š â†’ ç»‘å®šæˆåŠŸ
```

### 2. å…³é”®ç»„ä»¶

#### 2.1 RSAåŠ å¯†å·¥å…· (`lib/qixiangyun/rsa-utils.ts`)

**åŠŸèƒ½**ï¼šä½¿ç”¨ä¼äº«äº‘æä¾›çš„å…¬é’¥å¯¹å¯†ç è¿›è¡ŒRSA-OAEPåŠ å¯†

```typescript
import { encryptPassword, validatePhoneNumber, validatePassword } from '@/lib/qixiangyun/rsa-utils';

// åŠ å¯†å¯†ç 
const encrypted = await encryptPassword('myPassword123');

// éªŒè¯æ‰‹æœºå·
const isValid = validatePhoneNumber('13800138000'); // true/false

// éªŒè¯å¯†ç æ ¼å¼
const isValidPwd = validatePassword('123456'); // true/false
```

**ç‰¹æ€§**ï¼š
- ä½¿ç”¨Web Crypto APIè¿›è¡ŒåŠ å¯†
- æ”¯æŒåˆ†å—åŠ å¯†ï¼ˆæ¯å—æœ€å¤§117å­—èŠ‚ï¼‰
- è¿”å›Base64ç¼–ç çš„åŠ å¯†ç»“æœ
- å…¼å®¹æµè§ˆå™¨ç«¯è¿è¡Œ

#### 2.2 è‡ªç„¶äººæœåŠ¡ (`lib/qixiangyun/natural-person.ts`)

**ä¸»è¦API**ï¼š

##### `queryNaturalPersonCompanies(phoneNumber, password)`

æŸ¥è¯¢åŠç¨äººåä¸‹çš„ä¼ä¸šåˆ—è¡¨

```typescript
import { queryNaturalPersonCompanies } from '@/lib/qixiangyun';

try {
  const companies = await queryNaturalPersonCompanies(
    '13800138000',  // åŠç¨äººæ‰‹æœºå·
    'MyPassword123' // ç¨åŠ¡APPå¯†ç 
  );
  
  // companies ç»“æ„
  // [
  //   {
  //     xh: 0,
  //     nsrsbh: '91440300xxxxx',  // çº³ç¨äººè¯†åˆ«å·
  //     nsrmc: 'æ·±åœ³å¸‚XXç§‘æŠ€æœ‰é™å…¬å¸', // ä¼ä¸šåç§°
  //     sflx: 'BSY',  // èº«ä»½ç±»å‹
  //     glzt: '00'    // å…³è”çŠ¶æ€(00=å·²å¯ç”¨)
  //   }
  // ]
  
  console.log(`æ‰¾åˆ° ${companies.length} å®¶ä¼ä¸š`);
} catch (error) {
  console.error('æŸ¥è¯¢å¤±è´¥:', error.message);
}
```

##### `validateTaxPayer(phoneNumber, password)`

éªŒè¯åŠç¨äººä¿¡æ¯æ˜¯å¦æ­£ç¡®

```typescript
import { validateTaxPayer } from '@/lib/qixiangyun';

const result = await validateTaxPayer(phoneNumber, password);

if (result.success) {
  console.log(`éªŒè¯æˆåŠŸ: ${result.message}`);
  console.log(`ä¼ä¸šæ•°é‡: ${result.count}`);
} else {
  console.error(`éªŒè¯å¤±è´¥: ${result.message}`);
}
```

#### 2.3 ç±»å‹å®šä¹‰ (`lib/qixiangyun/types.ts`)

```typescript
// è‡ªç„¶äººä¼ä¸šä¿¡æ¯
export interface NaturalPersonCompany {
  xh: number;           // åºå·
  nsrsbh: string;       // çº³ç¨äººè¯†åˆ«å·
  nsrmc: string;        // çº³ç¨äººåç§°
  sflx: string;         // èº«ä»½ç±»å‹ (BSY=åŠç¨å‘˜)
  glzt: string;         // å…³è”çŠ¶æ€ (00=å·²å¯ç”¨)
}

// æŸ¥è¯¢è¯·æ±‚
export interface QueryOrglistRequest {
  gryhm: string;        // ä¸ªäººç”¨æˆ·å(æ‰‹æœºå·)
  gryhmm: string;       // å¯†ç (RSAåŠ å¯†å)
}

// æŸ¥è¯¢å“åº”
export interface QueryOrglistResponse {
  msg: string;
  result: NaturalPersonCompany[];
  code: string;
}
```

### 3. UIç•Œé¢è¯´æ˜

#### 3.1 æ­¥éª¤æµç¨‹

```
Step 1: åŠç¨äººè®¤è¯
  â†“
Step 2: é€‰æ‹©ä¼ä¸š
  â†“
Step 3: æŸ¥çœ‹ä¼ä¸šè¯¦æƒ…å¹¶ç¡®è®¤
  â†“
Step 4: ç»‘å®šæˆåŠŸ
```

#### 3.2 è¡¨å•å­—æ®µ

| å­—æ®µ | å¿…å¡« | è¯´æ˜ | éªŒè¯è§„åˆ™ |
|------|------|------|----------|
| åŠç¨äºº | âœ… | åŠç¨äººçœŸå®å§“å | éç©º |
| åŠç¨äººæ‰‹æœºå· | âœ… | åœ¨ç¨åŠ¡å±€æ³¨å†Œçš„æ‰‹æœºå· | 11ä½æ‰‹æœºå·æ ¼å¼ |
| åŠç¨äººå¯†ç  | âœ… | ç¨åŠ¡APPç™»å½•å¯†ç  | è‡³å°‘6ä½ |

#### 3.3 é¡µé¢è·¯å¾„

- è·¯å¾„: `/user/bindcompany`
- ç»„ä»¶: `app/user/bindcompany/page.tsx`

## å®‰å…¨æ€§è¯´æ˜

### 1. å¯†ç åŠ å¯†

- å¯†ç åœ¨å‰ç«¯ä½¿ç”¨RSAå…¬é’¥åŠ å¯†
- ä½¿ç”¨çš„æ˜¯ä¼äº«äº‘å®˜æ–¹æä¾›çš„1024ä½RSAå…¬é’¥
- åŠ å¯†ç®—æ³•: RSA-OAEP with SHA-1
- æ˜æ–‡å¯†ç ä¸ä¼šåœ¨ç½‘ç»œä¼ è¾“ä¸­æš´éœ²

### 2. æ•°æ®å­˜å‚¨

- å¯†ç ä¸ä¼šå­˜å‚¨åœ¨æœ¬åœ°
- åªä¿å­˜ç»‘å®šçš„ä¼ä¸šä¿¡æ¯
- ä½¿ç”¨localStorageå­˜å‚¨ç”¨æˆ·ä¼šè¯

### 3. APIè°ƒç”¨

- æ‰€æœ‰APIè¯·æ±‚éƒ½å¸¦æœ‰ç­¾åéªŒè¯
- ä½¿ç”¨access_tokenè¿›è¡Œèº«ä»½è®¤è¯
- è¯·æ±‚ç­¾åé˜²æ­¢ç¯¡æ”¹

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|--------|------|----------|
| 4006 | ç™»å½•æ–¹å¼ä¸æ­£ç¡® | æ£€æŸ¥æ‰‹æœºå·å’Œå¯†ç æ˜¯å¦æ­£ç¡® |
| 4001 | è®¤è¯å¤±è´¥ | æ£€æŸ¥AppKeyå’ŒAppSecreté…ç½® |
| 4002 | access_tokenå·²è¿‡æœŸ | è‡ªåŠ¨åˆ·æ–°tokenåé‡è¯• |

### é”™è¯¯ç¤ºä¾‹

```typescript
try {
  const companies = await queryNaturalPersonCompanies(phone, pwd);
} catch (error) {
  if (error instanceof QixiangyunError) {
    switch (error.code) {
      case '4006':
        alert('æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯');
        break;
      case '4001':
        alert('ç³»ç»Ÿé…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        break;
      default:
        alert(`é”™è¯¯: ${error.message}`);
    }
  }
}
```

## æµ‹è¯•è¯´æ˜

ç”±äºè¿™æ˜¯çœŸå®çš„ç¨åŠ¡ç³»ç»Ÿæ¥å£ï¼Œéœ€è¦ä½¿ç”¨çœŸå®çš„åŠç¨äººè´¦å·è¿›è¡Œæµ‹è¯•ï¼š

### æµ‹è¯•å‰æ

1. éœ€è¦æœ‰çœŸå®çš„ç¨åŠ¡APPè´¦å·
2. è¯¥è´¦å·éœ€è¦åœ¨ç¨åŠ¡å±€ç»‘å®šè‡³å°‘ä¸€å®¶ä¼ä¸š
3. ä¼ä¸šçŠ¶æ€ä¸º"å·²å¯ç”¨"

### æµ‹è¯•æ­¥éª¤

1. è®¿é—® `http://localhost:3008/user/bindcompany`
2. è¾“å…¥åŠç¨äººå§“å
3. è¾“å…¥åŠç¨äººæ‰‹æœºå·
4. è¾“å…¥ç¨åŠ¡APPå¯†ç 
5. ç‚¹å‡»"è®¤è¯å¹¶æŸ¥è¯¢åä¸‹ä¼ä¸š"
6. åœ¨ä¼ä¸šåˆ—è¡¨ä¸­é€‰æ‹©è¦ç»‘å®šçš„ä¼ä¸š
7. ç¡®è®¤ä¼ä¸šè¯¦æƒ…åç‚¹å‡»"ç¡®è®¤ç»‘å®š"

## é…ç½®è¦æ±‚

ç¡®ä¿ `.env.local` æ–‡ä»¶ä¸­åŒ…å«ä»¥ä¸‹é…ç½®ï¼š

```env
# ä¼äº«äº‘APIé…ç½®
NEXT_PUBLIC_QIXIANGYUN_BASE_URL=https://mcp.qixiangyun.com
QIXIANGYUN_APPKEY=10001995
QIXIANGYUN_APPSECRET=abPy4n7MPuPB8SXAIUrqixVDDv0SPVMYGx1ljIDKEAvXsuYm
```

## å¼€å‘æ³¨æ„äº‹é¡¹

1. **RSAåŠ å¯†åœ¨æµè§ˆå™¨ç«¯æ‰§è¡Œ**
   - ä½¿ç”¨Web Crypto API
   - ä¸ä¾èµ–Node.jsçš„cryptoæ¨¡å—
   - å…¼å®¹ç°ä»£æµè§ˆå™¨

2. **APIè°ƒç”¨æµç¨‹**
   ```
   ç”¨æˆ·è¾“å…¥å¯†ç  â†’ RSAåŠ å¯† â†’ å‘é€åˆ°ä¼äº«äº‘ â†’ ä¼äº«äº‘éªŒè¯ â†’ è¿”å›ä¼ä¸šåˆ—è¡¨
   ```

3. **ä¼ä¸šç­›é€‰**
   - åªæ˜¾ç¤º `glzt === '00'` (å·²å¯ç”¨) çš„ä¼ä¸š
   - è‡ªåŠ¨è¿‡æ»¤æœªå¯ç”¨æˆ–å·²è§£ç»‘çš„ä¼ä¸š

4. **é”™è¯¯æç¤º**
   - å‹å¥½çš„ä¸­æ–‡é”™è¯¯æç¤º
   - åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
   - æä¾›è§£å†³å»ºè®®

## ç›¸å…³æ–‡ä»¶

- ğŸ†• `lib/qixiangyun/natural-person.ts` - è‡ªç„¶äººæœåŠ¡
- ğŸ†• `lib/qixiangyun/rsa-utils.ts` - RSAåŠ å¯†å·¥å…·
- ğŸ“ `lib/qixiangyun/types.ts` - ç±»å‹å®šä¹‰(å·²æ›´æ–°)
- ğŸ“ `lib/qixiangyun/index.ts` - ç»Ÿä¸€å¯¼å‡º(å·²æ›´æ–°)
- ğŸ“ `app/user/bindcompany/page.tsx` - ä¼ä¸šç»‘å®šé¡µé¢(å·²é‡æ„)

## åŠŸèƒ½ä¼˜åŠ¿

âœ… **çœŸå®å¯ç”¨** - è°ƒç”¨çœŸå®çš„ç¨åŠ¡ç³»ç»ŸAPI  
âœ… **å®‰å…¨å¯é ** - RSAåŠ å¯†ä¿æŠ¤å¯†ç å®‰å…¨  
âœ… **è‡ªåŠ¨è·å–** - æ— éœ€æ‰‹åŠ¨è¾“å…¥ä¼ä¸šä¿¡æ¯  
âœ… **ä¾¿æ·é«˜æ•ˆ** - ä¸€é”®è®¤è¯ï¼Œè‡ªåŠ¨å¸¦å‡ºä¼ä¸š  
âœ… **ç”¨æˆ·å‹å¥½** - æ¸…æ™°çš„æ­¥éª¤å¼•å¯¼å’Œé”™è¯¯æç¤º  

## ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ çŸ­ä¿¡éªŒè¯**
   - åŒå› ç´ è®¤è¯å¢å¼ºå®‰å…¨æ€§
   
2. **æ”¯æŒå¤šä¼ä¸šç®¡ç†**
   - å…è®¸ç”¨æˆ·åˆ‡æ¢ç»‘å®šçš„ä¼ä¸š
   
3. **ç¼“å­˜ä¼ä¸šåˆ—è¡¨**
   - é¿å…é‡å¤è®¤è¯
   
4. **è®°ä½ç™»å½•çŠ¶æ€**
   - ä¼ä¸šç»‘å®šåä¿æŒç™»å½•

5. **æ·»åŠ ä¼ä¸šéªŒè¯ç ç™»å½•**
   - æ”¯æŒæ‰«ç ç™»å½•æ–¹å¼

